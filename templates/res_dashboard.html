<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Researcher Dashboard - African Critical Minerals</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #7c3aed;
            font-size: 24px;
            font-weight: 600;
        }

        .btn-logout {
            background: #ef4444;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .main-content {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #7c3aed;
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .stat-card .value {
            color: #7c3aed;
            font-size: 32px;
            font-weight: 700;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .section h2 {
            color: #7c3aed;
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e9ecef;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            color: #666;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #7c3aed;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #7c3aed;
            border-bottom-color: #7c3aed;
        }

        .tab:hover {
            color: #7c3aed;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-export {
            background: #10b981;
            color: white;
            margin-bottom: 15px;
            margin-right: 10px;
        }

        .btn-export:hover {
            background: #059669;
        }

        .btn-add {
            background: #7c3aed;
            color: white;
            padding: 10px 20px;
            margin-bottom: 15px;
        }

        .btn-add:hover {
            background: #6d28d9;
        }

        .btn-save {
            background: #7c3aed;
            color: white;
        }

        .btn-save:hover {
            background: #6d28d9;
        }

        .btn-cancel {
            background: #6b7280;
            color: white;
        }

        .btn-cancel:hover {
            background: #4b5563;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #7c3aed;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .success-message {
            background: #10b981;
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .insights-list {
            margin-top: 20px;
        }

        .insight-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #7c3aed;
        }

        .insight-card h4 {
            color: #7c3aed;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .insight-card .meta {
            color: #666;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .insight-card .content {
            color: #333;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>Researcher Dashboard - Data Analysis</h1>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </header>

    <div id="successMessage" class="success-message"></div>

    <!-- Add Insight Modal -->
    <div id="addInsightModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Research Insight</h3>
            </div>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="insightTitle" placeholder="Enter insight title">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="insightCategory">
                    <option value="Mineral Analysis">Mineral Analysis</option>
                    <option value="Country Analysis">Country Analysis</option>
                    <option value="Production Trends">Production Trends</option>
                    <option value="Market Analysis">Market Analysis</option>
                    <option value="General Research">General Research</option>
                </select>
            </div>
            <div class="form-group">
                <label>Content</label>
                <textarea id="insightContent" placeholder="Enter your research insights, findings, or analysis..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeAddInsightModal()">Cancel</button>
                <button class="btn btn-save" onclick="saveNewInsight()">Add Insight</button>
            </div>
        </div>
    </div>

    <main class="main-content">
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>Total Minerals</h3>
                <div class="value" id="totalMinerals">
                    <div class="spinner"></div>
                </div>
            </div>
            <div class="stat-card">
                <h3>Total Countries</h3>
                <div class="value" id="totalCountries">
                    <div class="spinner"></div>
                </div>
            </div>
            <div class="stat-card">
                <h3>Research Insights</h3>
                <div class="value" id="totalInsights">
                    <div class="spinner"></div>
                </div>
            </div>
            <div class="stat-card">
                <h3>Production Records</h3>
                <div class="value" id="totalProduction">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Minerals Data</h2>
            <button class="btn btn-export" onclick="exportMineralsData()">📥 Export to CSV</button>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('minerals-data')">Data Table</button>
                <button class="tab" onclick="switchTab('minerals-chart')">Price Chart</button>
            </div>
            <div id="minerals-data" class="tab-content active">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading minerals data...
                </div>
                <div class="table-container" id="mineralsTable"></div>
            </div>
            <div id="minerals-chart" class="tab-content">
                <div class="chart-container">
                    <canvas id="mineralsChart"></canvas>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Countries Data</h2>
            <button class="btn btn-export" onclick="exportCountriesData()">📥 Export to CSV</button>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('countries-data')">Data Table</button>
                <button class="tab" onclick="switchTab('countries-chart')">GDP Chart</button>
            </div>
            <div id="countries-data" class="tab-content active">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading countries data...
                </div>
                <div class="table-container" id="countriesTable"></div>
            </div>
            <div id="countries-chart" class="tab-content">
                <div class="chart-container">
                    <canvas id="countriesChart"></canvas>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Production Statistics</h2>
            <button class="btn btn-export" onclick="exportProductionData()">📥 Export to CSV</button>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('production-data')">Data Table</button>
                <button class="tab" onclick="switchTab('production-chart')">Trends Chart</button>
            </div>
            <div id="production-data" class="tab-content active">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading production data...
                </div>
                <div class="table-container" id="productionTable"></div>
            </div>
            <div id="production-chart" class="tab-content">
                <div class="chart-container">
                    <canvas id="productionChart"></canvas>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Research Insights</h2>
            <button class="btn btn-add" onclick="openAddInsightModal()">+ Add New Insight</button>
            <button class="btn btn-export" onclick="exportInsightsData()">📥 Export to CSV</button>
            <div class="loading">
                <div class="spinner"></div>
                Loading insights...
            </div>
            <div class="insights-list" id="insightsList"></div>
        </div>
    </main>

    <script>
        let charts = {};
        let cachedData = {};

       // Load CSV file
        async function loadCSV(filename) {
            try {
                // Add ../ prefix for parent directory
                const filePath = `../${filename}`;
                console.log(`Attempting to load: ${filePath}`);
                
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`Failed to load ${filename}: ${response.status} ${response.statusText}`);
                }
                const csvText = await response.text();
                
                return new Promise((resolve, reject) => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        dynamicTyping: false,
                        complete: function(results) {
                            if (results.errors && results.errors.length > 0) {
                                console.warn(`Parsing warnings for ${filename}:`, results.errors);
                            }
                            const cleanData = results.data.filter(row => {
                                return Object.values(row).some(value => value && value.trim() !== '');
                            });
                            console.log(`${filename} loaded:`, cleanData.length, 'rows');
                            resolve(cleanData);
                        },
                        error: function(error) {
                            console.error(`Error parsing ${filename}:`, error);
                            reject(error);
                        }
                    });
                });
            } catch (error) {
                console.error(`Error loading ${filename}:`, error);
                throw error;
            }
        }

        // Download CSV
        function downloadCSV(filename, data) {
            if (!data || data.length === 0) return;
            
            const csv = Papa.unparse(data);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Update statistics
        function updateStatsCount(elementId, count) {
            const element = document.getElementById(elementId);
            element.innerHTML = count;
        }

        // Show error
        function showError(containerId, message) {
            const container = document.getElementById(containerId).parentElement;
            const loadingElement = container.querySelector('.loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            container.innerHTML += `<div class="error">${message}</div>`;
        }

        // Show success
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.add('show');
            successDiv.style.position = 'fixed';
            successDiv.style.top = '80px';
            successDiv.style.left = '50%';
            successDiv.style.transform = 'translateX(-50%)';
            successDiv.style.zIndex = '1001';
            
            setTimeout(() => {
                successDiv.classList.remove('show');
            }, 3000);
        }

        // Load and render minerals
        async function loadAndRenderMinerals() {
            try {
                const minerals = await loadCSV('minerals.csv');
                cachedData.minerals = minerals;
                renderMineralsTable(minerals);
                renderMineralsChart(minerals);
                updateStatsCount('totalMinerals', minerals.length);
            } catch (error) {
                showError('mineralsTable', 'Failed to load minerals data: ' + error.message);
            }
        }

        // Load and render countries
        async function loadAndRenderCountries() {
            try {
                const countries = await loadCSV('countries.csv');
                cachedData.countries = countries;
                renderCountriesTable(countries);
                renderCountriesChart(countries);
                updateStatsCount('totalCountries', countries.length);
            } catch (error) {
                showError('countriesTable', 'Failed to load countries data: ' + error.message);
            }
        }

        // Load and render production
        async function loadAndRenderProduction() {
            try {
                const production = await loadCSV('production_stats.csv');
                cachedData.production = production;
                renderProductionTable(production);
                renderProductionChart(production);
                updateStatsCount('totalProduction', production.length);
            } catch (error) {
                showError('productionTable', 'Failed to load production data: ' + error.message);
            }
        }

        // Load and render insights
        async function loadAndRenderInsights() {
            try {
                const insights = await loadCSV('insights.csv');
                cachedData.insights = insights;
                renderInsightsList(insights);
                updateStatsCount('totalInsights', insights.length);
            } catch (error) {
                // If insights.csv doesn't exist yet, create empty state
                console.log('No insights file found, starting with empty list');
                cachedData.insights = [];
                renderInsightsList([]);
                updateStatsCount('totalInsights', 0);
            }
        }

        // Render minerals table
        function renderMineralsTable(minerals) {
            const container = document.getElementById('mineralsTable').parentElement;
            const loadingElement = container.querySelector('.loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }

            const tableContainer = document.getElementById('mineralsTable');
            
            if (!minerals || minerals.length === 0) {
                tableContainer.innerHTML = '<p class="error">No minerals data available</p>';
                return;
            }

            let html = '<table><thead><tr>';
            const headers = Object.keys(minerals[0]);
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            minerals.forEach(mineral => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td>${mineral[header] || '-'}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            tableContainer.innerHTML = html;
        }

        // Render countries table
        function renderCountriesTable(countries) {
            const container = document.getElementById('countriesTable').parentElement;
            const loadingElement = container.querySelector('.loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }

            const tableContainer = document.getElementById('countriesTable');
            
            if (!countries || countries.length === 0) {
                tableContainer.innerHTML = '<p class="error">No countries data available</p>';
                return;
            }

            let html = '<table><thead><tr>';
            const headers = Object.keys(countries[0]);
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            countries.forEach(country => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td>${country[header] || '-'}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            tableContainer.innerHTML = html;
        }

        // Render production table
        function renderProductionTable(production) {
            const container = document.getElementById('productionTable').parentElement;
            const loadingElement = container.querySelector('.loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }

            const tableContainer = document.getElementById('productionTable');
            
            if (!production || production.length === 0) {
                tableContainer.innerHTML = '<p class="error">No production data available</p>';
                return;
            }

            let html = '<table><thead><tr>';
            const headers = Object.keys(production[0]);
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            production.forEach(prod => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td>${prod[header] || '-'}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            tableContainer.innerHTML = html;
        }

        // Render insights list
        function renderInsightsList(insights) {
            const container = document.getElementById('insightsList').parentElement;
            const loadingElement = container.querySelector('.loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }

            const listContainer = document.getElementById('insightsList');
            
            if (!insights || insights.length === 0) {
                listContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No insights available yet. Click "Add New Insight" to create your first research insight.</p>';
                return;
            }

            let html = '';
            insights.forEach(insight => {
                html += `
                    <div class="insight-card">
                        <h4>${insight.Title || 'Untitled Insight'}</h4>
                        <div class="meta">
                            <span>${insight.Category || 'General'}</span> • 
                            <span>${insight.Date || 'No date'}</span> • 
                            <span>By: ${insight.Researcher || 'Unknown'}</span>
                        </div>
                        <div class="content">${insight.Content || 'No content'}</div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }

        // Render charts
        async function renderMineralsChart(minerals) {
            if (!minerals) {
                minerals = cachedData.minerals || await loadCSV('minerals.csv');
            }

            const ctx = document.getElementById('mineralsChart');
            if (!ctx) return;
            
            if (charts.minerals) {
                charts.minerals.destroy();
            }

            const priceField = Object.keys(minerals[0]).find(key => 
                key.toLowerCase().includes('price')
            );
            const nameField = Object.keys(minerals[0]).find(key => 
                key.toLowerCase().includes('name') || key.toLowerCase().includes('mineral')
            );

            if (!priceField || !nameField) return;

            const prices = minerals.map(m => parseFloat(m[priceField]) || 0);
            const mineralNames = minerals.map(m => m[nameField] || 'Unknown');
            
            charts.minerals = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: mineralNames,
                    datasets: [{
                        label: 'Price (USD)',
                        data: prices,
                        backgroundColor: '#7c3aed'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Mineral Price Comparison'
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
        }

        async function renderCountriesChart(countries) {
            if (!countries) {
                countries = cachedData.countries || await loadCSV('countries.csv');
            }

            const ctx = document.getElementById('countriesChart');
            if (!ctx) return;
            
            if (charts.countries) {
                charts.countries.destroy();
            }

            const gdpField = Object.keys(countries[0]).find(key => 
                key.toLowerCase().includes('gdp')
            );
            const nameField = Object.keys(countries[0]).find(key => 
                key.toLowerCase().includes('name') || key.toLowerCase().includes('country')
            );

            if (!gdpField || !nameField) return;
            
            const countryNames = countries.map(c => c[nameField] || 'Unknown');
            const gdps = countries.map(c => parseFloat(c[gdpField]) || 0);
            
            charts.countries = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: countryNames,
                    datasets: [{
                        label: 'GDP (Billions USD)',
                        data: gdps,
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Country GDP Comparison'
                        }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        }

        async function renderProductionChart(production) {
            if (!production) {
                production = cachedData.production || await loadCSV('production_stats.csv');
            }

            const ctx = document.getElementById('productionChart');
            if (!ctx) return;
            
            if (charts.production) {
                charts.production.destroy();
            }

            const yearField = Object.keys(production[0]).find(key => 
                key.toLowerCase().includes('year')
            );
            const quantityField = Object.keys(production[0]).find(key => 
                key.toLowerCase().includes('quantity') || key.toLowerCase().includes('production')
            );

            if (!yearField || !quantityField) return;
            
            const productionByYear = {};
            production.forEach(p => {
                const year = p[yearField] || '';
                const quantity = parseFloat(p[quantityField]) || 0;
                if (!productionByYear[year]) {
                    productionByYear[year] = 0;
                }
                productionByYear[year] += quantity;
            });
            
            const years = Object.keys(productionByYear).sort();
            const quantities = years.map(year => productionByYear[year]);
            
            charts.production = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Total Production',
                        data: quantities,
                        borderColor: '#7c3aed',
                        backgroundColor: 'rgba(124, 58, 237, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Production Trends Over Time'
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        // Tab switching
        function switchTab(tabId) {
            const section = document.getElementById(tabId).closest('.section');
            
            section.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            section.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            if (tabId.includes('chart')) {
                const chartType = tabId.split('-')[0];
                setTimeout(() => {
                    switch(chartType) {
                        case 'minerals':
                            renderMineralsChart();
                            break;
                        case 'countries':
                            renderCountriesChart();
                            break;
                        case 'production':
                            renderProductionChart();
                            break;
                    }
                }, 100);
            }
        }

        // Export functions
        function exportMineralsData() {
            if (cachedData.minerals && cachedData.minerals.length > 0) {
                downloadCSV('minerals_export.csv', cachedData.minerals);
                showSuccess('Minerals data exported successfully!');
            } else {
                alert('No minerals data available to export');
            }
        }

        function exportCountriesData() {
            if (cachedData.countries && cachedData.countries.length > 0) {
                downloadCSV('countries_export.csv', cachedData.countries);
                showSuccess('Countries data exported successfully!');
            } else {
                alert('No countries data available to export');
            }
        }

        function exportProductionData() {
            if (cachedData.production && cachedData.production.length > 0) {
                downloadCSV('production_export.csv', cachedData.production);
                showSuccess('Production data exported successfully!');
            } else {
                alert('No production data available to export');
            }
        }

        function exportInsightsData() {
            if (cachedData.insights && cachedData.insights.length > 0) {
                downloadCSV('insights_export.csv', cachedData.insights);
                showSuccess('Insights data exported successfully!');
            } else {
                alert('No insights data available to export');
            }
        }

        // Modal functions
        function openAddInsightModal() {
            document.getElementById('addInsightModal').classList.add('active');
        }

        function closeAddInsightModal() {
            document.getElementById('addInsightModal').classList.remove('active');
            document.getElementById('insightTitle').value = '';
            document.getElementById('insightCategory').value = 'Mineral Analysis';
            document.getElementById('insightContent').value = '';
        }

        async function saveNewInsight() {
            const title = document.getElementById('insightTitle').value;
            const category = document.getElementById('insightCategory').value;
            const content = document.getElementById('insightContent').value;
            
            if (!title || !content) {
                alert('Please fill in title and content');
                return;
            }
            
            try {
                let insights = [];
                
                // Try to load existing insights
                try {
                    insights = await loadCSV('insights.csv');
                } catch (error) {
                    console.log('No existing insights file, creating new one');
                    insights = [];
                }
                
                // Generate new InsightID
                const maxId = insights.length > 0 ? Math.max(...insights.map(i => parseInt(i.InsightID) || 0)) : 0;
                const newInsightId = maxId + 1;
                
                // Get current date
                const currentDate = new Date().toISOString().split('T')[0];
                
                // Create new insight object
                const newInsight = {
                    InsightID: newInsightId.toString(),
                    Title: title,
                    Category: category,
                    Content: content,
                    Date: currentDate,
                    Researcher: 'Researcher' // You can modify this to use actual logged-in user
                };
                
                insights.push(newInsight);
                
                // Download updated CSV
                downloadCSV('insights.csv', insights);
                
                closeAddInsightModal();
                showSuccess('Insight added successfully!');
                
                // Reload insights after a short delay
                setTimeout(() => {
                    loadAndRenderInsights();
                }, 1000);
            } catch (error) {
                alert('Failed to add insight: ' + error.message);
            }
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = './login.html';
            }
        }

        // Initialize dashboard
        async function initializeDashboard() {
            await Promise.allSettled([
                loadAndRenderMinerals(),
                loadAndRenderCountries(),
                loadAndRenderProduction(),
                loadAndRenderInsights()
            ]);
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>